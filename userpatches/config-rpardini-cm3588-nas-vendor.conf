declare -g BOARD=cm3588-nas
declare -g BRANCH=vendor
declare -g RELEASE=bookworm
declare -g CLOUD_INIT_RECIPE=arm2024_vmtest
declare -g CLOUD_INIT_INSTANCE_ID=cm3588-nas-vendor

display_alert "CM3588-NAS BOARD" "${BOARD}" "info"
display_alert "CM3588-NAS BRANCH" "${BRANCH}" "info"
display_alert "CM3588-NAS RELEASE" "${RELEASE}" "info"
display_alert "CM3588-NAS CLOUD_INIT_RECIPE" "${CLOUD_INIT_RECIPE}" "info"
display_alert "CM3588-NAS CLOUD_INIT_INSTANCE_ID" "${CLOUD_INIT_INSTANCE_ID}" "info"

echo "config-rpardini-cm3588-nas-vendor config for ${BOARD}"

function cloud_init_modify_network_config__cm3588() {
	declare -A netconf=()
	netconf[interface]="eth0"
	netconf[macaddress]="E2:AA:08:31:73:86"
	netconf[ipv4]="192.168.66.170/24"
	netconf[ipv6]="2a02:a466:4d7a:1:e0aa:8ff:fe31:7386/64"

	display_alert "Writing CM3588 ${BLADE3} network config to cloud-init" "${BOARD} ${BRANCH}" "warn"
	local target_net_conf="${CI_TARGET}${CLOUD_INIT_CONFIG_LOCATION}"/network-config
	# Attention, this is YAML, so wihtespace is significant!
	cat <<- CLOUD_INIT_NETWORK_CONFIG_WIFI > "${target_net_conf}"
		version: 2
		renderer: networkd
		ethernets:
		  ${netconf[interface]}:
		    dhcp4: false
		    dhcp6: false
		    optional: true
		bridges:
		  lan:
		    dhcp4: false
		    dhcp6: false
		    interfaces:
		      - ${netconf[interface]}
		    optional: false # Hmm. This has been controversial in the past, and impedes boot on some bridge configs
		    macaddress: ${netconf[macaddress]}
		    addresses:
		      - ${netconf[ipv4]}
		      - ${netconf[ipv6]}
		    routes:
		      - to: default # legacy was gateway4
		        via: 192.168.66.1
		      - to: default # legacy was gateway6
		        via: 2a02:a466:4d7a:1:5e49:79ff:fe58:2b10
		    nameservers:
		      addresses:
		        - 2a02:a466:4d7a:1:5e49:79ff:fe58:2b10
		        - 192.168.66.1
	CLOUD_INIT_NETWORK_CONFIG_WIFI

	display_alert "Final c-i network-config" "${target_net_conf}" "warn"
	run_host_command_logged cat "${target_net_conf}"
}

# common stuff for all my builds. activates a bunch of extensions.
source common-rpardini.conf
